# 跨域

## 跨域定义／简介

只要协议、域名、端口有任何一个不同，都被当作是不同的域。浏览器有一个同源策略，其限制之一是不能通过ajax的方法去请求不同源中的文档。第二个限制是浏览器中不同域的框架之间是不能进行js的交互操作的。

```Javascript
URL                             说明              是否允许通信

http://www.a.com/a.js
http://www.a.com/b.js           //同一域名下          允许

http://www.a.com/lab/a.js
http://www.a.com/script/b.js    //同一域名下不同文件夹  允许

http://www.a.com:8000/a.js
http://www.a.com/b.js           //同一域名，不同端口   不允许

http://www.a.com/a.js
https://www.a.com/b.js          //同一域名，不同协议    不允许

http://www.a.com/a.js
http://70.32.92.74/b.js         //域名和域名对应ip     不允许

http://www.a.com/a.js
http://script.a.com/b.js        //主域相同，子域不同    不允许（cookie这种情况下也不允许访问）

http://www.a.com/a.js
http://a.com/b.js               //同一域名，不同二级域名（同上）不允许（cookie这种情况下也不允许访问）

http://www.cnblogs.com/a.js
http://www.a.com/b.js           //不同域名 不允许
```

1. 如果是协议和端口造成的跨域问题“前台”是无能为力的；
2. 在跨域问题上，域仅仅是通过“URL的首部”来识别而不会去尝试判断相同的ip地址对应着两个域或两个域是否在同一个ip上。
   (“URL的首部”指window.location.protocol +window.location.host，也可以理解为“Domains, protocols and ports must match”。)


## 跨域方法

1. 通过document.domain跨域

   修改document.domain的方法只适用于不同子域的框架间的交互。

   有一个页面，它的地址是http://www.example.com/a.html， 在这个页面里面有一个iframe，它的src是http://example.com/b.html，在不同子域js里设置document.domain='example.com';

   ​

2. 通过location.hash跨域

   iframe可以读写父窗口的URL，URL#号及其后面的字符被称为hash，这部分的修改不会产生HTTP请求，但是会产生浏览器历史记录。此方法的原理就是改变URL的hash部分来进行双向通信，通过onhashchange事件或轮询来获知URL的改变。

   由于两个页面不在同一个域下IE、Chrome不允许修改parent.location.hash的值，所以要借助于父窗口域名下的一个代理iframe。

   - 父页面向子页面传递：修改父页面hash，子页面监听url变化。

   - 子页面向父页面传递：在子页面中新建与父页面同域的代理iframe，并挂上要传送的hash数据，因为同域，父页面可以监听代理iframe的url变化。

     ```javascript
     //子页面
     try {  
         parent.location.hash = 'data';  
     } catch (e) {  
         // ie、chrome的安全机制无法修改parent.location.hash，  
         var ifrproxy = document.createElement('iframe');  
         ifrproxy.style.display = 'none';  
         ifrproxy.src = "http://www.baidu.com/proxy.html#data";  
         document.body.appendChild(ifrproxy);  
     }

     //代理iframe
     //因为parent.parent（即baidu.com/a.html）和baidu.com/proxy.html属于同一个域，所以可以改变其location.hash的值  
     parent.parent.location.hash = self.location.hash.substring(1);
     ```

   ​

3. 通过HTML5的postMessage方法跨域

   ```Javascript
   //父页面向子iframe传递
   //子页面监听message事件，接受传递的数据
   ifr.contentWindow.postMessage('hello world!', targetOrigin); 
   ```

   ​

4. jsonp跨域

   利用src链接可跨域来传递数据。

   ```Javascript
   function handleResponse(response){ alert("You’re at IP address " + response.ip + ", which is in " + response.city + ", " + response.region_name); }

   var script = document.createElement("script"); script.src = "http://freegeoip.net/json/?callback=handleResponse"; document.body.insertBefore(script, document.body.firstChild);
   ```



5. CORS跨域

   ```javascript
   Access-Control-Allow-Origin: http://api.bob.com
   //如果要把Cookie发到服务器，一方面要服务器同意，指定Access-Control-Allow-Credentials字段。另一方面，开发者必须在AJAX请求中打开withCredentials属性。
   Access-Control-Allow-Credentials: true
   Access-Control-Expose-Headers: FooBar
   Content-Type: text/html; charset=utf-8
   ```



6. Window.name跨域

   window对象有个name属性：即在一个窗口(window)的生命周期内,窗口载入的所有的页面都是共享一个window.name的，每个页面对window.name都有读写的权限，window.name是持久存在一个窗口载入过的所有页面中的，并不会因新页面的载入而进行重置。


## 参考

1. [前端跨域整理][1]

   [1]: https://gold.xitu.io/post/5815f4abbf22ec006893b431 "前端跨域整理"
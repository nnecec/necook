# HTTP 报文

> 《HTTP 权威指南》第三章 HTTP 报文

## 报文是如何流动的 - 报文流

HTTP 报文是在 HTTP 应用程序之间发送的数据块。

这些数据块以一些文本形式的元信息（meta-information）开头，这些信息描述了报文的内容及含义，后面跟着可选的数据部分。这些报文在客户端、服务器和代理之间流动。

HTTP 使用术语流入（inbound）和流出（outbound）来描述事务处理（transaction）的方向。

HTTP 报文会像河水一样流动。不管是请求报文还是响应报文，所有报文都会向下游（downstream）流动。所有报文的发送者都在接收者的上游。

## 请求和响应报文之间的区别 - HTTP 报文的三个组成部分（起始行、首部和实体的主体部分）

由三个部分组成：对报文进行描述的起始行（start line）、包含属性的首部（header）块，以及可选的、包含数据的主体（body）部分。起始行和首部就是由行分隔的 ASCII 文本。实体的主体或报文的主体（或者就称为主体）是一个可选的数据块。

### 报文的语法

所有的 HTTP 报文都可以分为两类：请求报文（request message）和响应报文（response message）。

```
// 请求报文
<method> <request-URL> <version>
<headers>

<entity-body>

// 响应报文
<version> <status> <reason-phrase>
<headers>

<entity-body>
```

- 方法(method): 客户端希望服务器对资源执行的动作
- 请求 URL(request-URL): 命名了所请求资源，或者 URL 路径组件的完整 URL。
- 版本(version): 报文所使用的 HTTP 版本，其格式看起来是这样的：`HTTP/<major>.<minor>`其中主要版本号（major）和次要版本号（minor）都是整数。
- 状态码(status-code): 这三位数字描述了请求过程中所发生的情况。
- 原因短语(reason-phrase): 数字状态码的可读版本，包含行终止序列之前的所有文本。
- 首部(header): 可以有零个或多个首部，每个首部都包含一个名字，后面跟着一个冒号（:），然后是一个可选的空格，接着是一个值，最后是一个 CRLF。
- 实体的主体部分(entity-body): 实体的主体部分包含一个由任意数据组成的数据块。

### 请求报文支持的各种功能（方法） - 起始行

所有的 HTTP 报文都以一个起始行作为开始。请求报文的起始行说明了要做些什么。响应报文的起始行说明发生了什么。

1. 请求行：请求报文请求服务器对资源进行一些操作。请求报文的起始行，或称为请求行，包含了一个方法和一个请求 URL，这个方法描述了服务器应该执行的操作，请求 URL 描述了要对哪个资源执行这个方法。请求行中还包含 HTTP 的版本，用来告知服务器，客户端使用的是哪种 HTTP。
2. 响应行：响应报文承载了状态信息和操作产生的所有结果数据，将其返回给客户端。响应报文的起始行，或称为响应行，包含了响应报文使用的 HTTP 版本、数字状态码，以及描述操作状态的文本形式的原因短语。
3. 方法：请求的起始行以方法作为开始，方法用来告知服务器要做些什么。

- 安全方法：HTTP 定义了一组被称为安全方法的方法。GET 方法和 HEAD 方法都被认为是安全的，这就意味着使用 GET 或 HEAD 方法的 HTTP 请求都不会产生什么动作。不产生动作，在这里意味着 HTTP 请求不会在服务器上产生什么结果。
- GET：通常用于请求服务器发送某个资源。
- HEAD：HEAD 方法与 GET 方法的行为很类似，但服务器在响应中只返回首部。不会返回实体的主体部分。这就允许客户端在未获取实际资源的情况下，对资源的首部进行检查。
- PUT：与 GET 从服务器读取文档相反，PUT 方法会向服务器写入文档。
- POST：POST 方法起初是用来向服务器输入数据的。
- TRACE：客户端发起一个请求时，这个请求可能要穿过防火墙、代理、网关或其他一些应用程序。每个中间节点都可能会修改原始的 HTTP 请求。TRACE 方法允许客户端在最终将请求发送给服务器时，看看它变成了什么样子。
- OPTIONS：OPTIONS 方法请求 Web 服务器告知其支持的各种功能。可以询问服务器通常支持哪些方法，或者对某些特殊资源支持哪些方法。
- DELETE：DELETE 方法所做的事情就是请服务器删除请求 URL 所指定的资源。但是，客户端应用程序无法保证删除操作一定会被执行。

方法|描述|是否包含主体
:-:|:-:|:-:
GET|从服务器获取一份文档|否
HEAD|只从服务器获取文档的首部|否
POST|向服务器发送需要处理的数据|是
PUT|将请求的主体部分存储在服务器上|是
TRACE|对可能经过代理服务器传送到服务器上去的报文进行追踪|否
OPTIONS|决定可以在服务器上执行哪些方法|否
DELETE|从服务器上删除一份文档|否

4. 状态码:方法是用来告诉服务器做什么事情的，状态码则用来告诉客户端，发生了什么事情。状态码位于响应的起始行中。参见[和响应报文一起返回的各种状态码 - 状态码](./状态码.md)
5. 原因短语：原因短语是响应起始行中的最后一个组件。它为状态码提供了文本形式的解释。
6. 版本号：版本号会以 HTTP/x.y 的形式出现在请求和响应报文的起始行中。为 HTTP 应用程序提供了一种将自己所遵循的协议版本告知对方的方式。

### 各种各样的 HTTP 首部都是用来做什么的 - 首部

前一小节的重点是请求和响应报文的第一行（方法、状态码、原因短语和版本号）。跟在起始行后面的就是零个、一个或多个 HTTP 首部字段。

每个 HTTP 首部都有一种简单的语法：名字后面跟着冒号（ ：），然后跟上可选的空格，再跟上字段值，最后是一个 CRLF。

将长的首部行分为多行可以提高可读性，多出来的每行前面至少要有一个空格或制表符（tab）。

HTTP 规范定义了几种首部字段。应用程序也可以随意发明自己所用的首部。HTTP 首部可以分为以下几类。

#### 通用首部：既可以出现在请求报文中，也可以出现在响应报文中。

提供了与报文相关的最基本的信息

首部|描述
:-:|:-:
Connection|允许客户端和服务器指定与请求/响应连接有关的选项
Date1|提供日期和时间标志，说明报文是什么时间创建的
MIME-Version|给出了发送端使用的MIME版本
Trailer|如果报文采用了分块传输编码（chunked transfer encoding）方式，就可以用这个首部列出位于报文拖挂（trailer）部分的首部集合
Transfer-Encoding|告知接收端为了保证报文的可靠传输，对报文采用了什么编码方式
Update|给出了发送端可能想要“升级”使用的新版本或协议
Via|显示了报文经过的中间节点（代理、网关）
Cache-Control|用于随报文传送缓存指示
Pragma|另一种随报文传送指示的方式，但并不专用于缓存

#### 请求首部：提供更多有关请求的信息。

请求首部是只在请求报文中有意义的首部。用于说明是谁或什么在发送请求、请求源自何处，或者客户端的喜好及能力。服务器可以根据请求首部给出的客户端信息，试着为客户端提供更好的响应。

请求的信息性首部

首部|描述
:-:|:-:
Client-IP4|提供了运行客户端的机器的IP地址
From|提供了客户端用户的E-mail地址5
Host|给出了接收请求的服务器的主机名和端口号
Referer|提供了包含当前请求URI的文档的URL
UA-Color|提供了与客户端显示器的显示颜色有关的信息
UA-CPU6|给出了客户端CPU的类型或制造商
UA-Disp|提供了与客户端显示器（屏幕）能力有关的信息
UA-OS|给出了运行在客户端机器上的操作系统名称及版本
UA-Pixels|提供了客户端显示器的像素信息
User-Agent|将发起请求的应用程序名称告知服务器

1. Accept 首部

Accept 首部为客户端提供了一种将其喜好和能力告知服务器的方式，包括它们想要什么，可以使用什么，以及最重要的，它们不想要什么。

首部|描述
:-:|:-:
Accept|告诉服务器能够发送哪些媒体类型
Accept-Charset|告诉服务器能够发送哪些字符集
Accept-Encoding|告诉服务器能够发送哪些编码方式
Accept-Language|告诉服务器能够发送哪些语言
TE7|告诉服务器可以使用哪些扩展传输编码

2. 条件请求首部

客户端希望为请求加上某些限制。

首部|描述
:-:|:-:
Expect|允许客户端列出某请求所要求的服务器行为
If-Match|如果实体标记与文档当前的实体标记相匹配，就获取这份文档8
If-Modified-Since|除非在某个指定的日期之后资源被修改过，否则就限制这个请求
If-None-Match|如果提供的实体标记与当前文档的实体标记不相符，就获取文档
If-Range|允许对文档的某个范围进行条件请求
If-Unmodified-Since|除非在某个指定日期之后资源没有被修改过，否则就限制这个请求
Range|如果服务器支持范围请求，就请求资源的指定范围9

3. 安全请求首部

HTTP 本身就支持一种简单的机制，可以对请求进行质询 / 响应认证。

首部|描述
:-:|:-:
Authorization|包含了客户端提供给服务器，以便对其自身进行认证的数据
Cookie|客户端用它向服务器传送一个令牌——它并不是真正的安全首部，但确实隐含了安全功能
Cookie|用来说明请求端支持的cookie版本

4. 代理请求首部

随着因特网上代理的普遍应用，人们定义了几个首部来协助其更好地工作。

首部|描述
:-:|:-:
Max-Forward|在通往源端服务器的路径上，将请求转发给其他代理或网关的最大次数——与TRACE方法一同使用
Proxy-Authorization|与Authorization 首部相同，但这个首部是在与代理进行认证时使用的
Proxy-Connection|与Connection 首部相同，但这个首部是在与代理建立连接时使用的

#### 响应首部：提供更多有关响应的信息

响应报文有自己的响应首部集。响应首部为客户端提供了一些额外信息，比如谁在发送响应、响应者的功能，甚至与响应相关的一些特殊指令。这些首部有助于客户端处理响应，并在将来发起更好的请求。

首部|描述
:-:|:-:
Age|（从最初创建开始）响应持续时间12
Public13|服务器为其资源支持的请求方法列表
Retry-After|如果资源不可用的话，在此日期或时间重试
Server|服务器应用程序软件的名称和版本
Title14|对HTML文档来说，就是HTML文档的源端给出的标题
Warning|比原因短语中更详细一些的警告报文

1. 协商首部

2. 安全相应首部

#### 实体首部：描述主体的长度和内容，或者资源自身。

有很多首部可以用来描述 HTTP 报文的负荷。由于请求和响应报文中都可能包含实体部分，所以在这两种类型的报文中都可能出现这些首部。实体首部提供了有关实体及其内容的大量信息，从有关对象类型的信息，到能够对资源使用的各种有效的请求方法。

1. 内容首部：内容首部提供了与实体内容有关的特定信息，说明了其类型、尺寸以及处理它所需的其他有用信息。

 首部|描述
 :-:|:-:
 Content-Base16|解析主体中的相对URL时使用的基础URL
 Content-Encoding|对主体执行的任意编码方式
 Content-Language|理解主体时最适宜使用的自然语言
 Content-Length|主体的长度或尺寸
 Content-Location|资源实际所处的位置
 Content-MD5|主体的MD5校验和
 Content-Range|在整个资源中此实体表示的字节范围
 Content-Type|这个主体的对象类型

2. 实体缓存首部

通用的缓存首部说明了如何或什么时候进行缓存。

首部|描述
:-:|:-:
ETag|与此实体相关的实体标记17
Expires|实体不再有效，要从原始的源端再次获取此实体的日期和时间
Last-Modified|这个实体最后一次被修改的日期和时间

### 实体的主体部分

HTTP 报文的第三部分是可选的实体主体部分。实体的主体是 HTTP 报文的负荷。就是 HTTP 要传输的内容。
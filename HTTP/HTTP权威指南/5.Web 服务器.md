# Web 服务器

> 《HTTP 权威指南》第五章 Web 服务器

- 对多种使用不同类型软硬件的 Web 服务器进行调查。
- 介绍如何用 Perl 编写简单的诊断性 Web 服务器。
- 一步一步地解释 Web 服务器是如何处理 HTTP 事务的。

## 各种形状和尺寸的 Web 服务器

### Web服务器的实现

Web 服务器实现了 HTTP 和相关的 TCP 连接处理。负责管理 Web 服务器提供的资源，以及对 Web 服务器的配置、控制及扩展方面的管理。

1. 通用软件Web服务器
2. Web服务器设备
3. 嵌入式Web服务器

## 最小的 Perl Web 服务器

所要做的就是支持 HTTP/1.1 的各种特性：丰富的资源支持、虚拟主机、访问控制、日志记录、配置、监视和性能特性。

## 实际的 Web 服务器会做些什么

1. 接受客户端连接
    - 处理新连接
    - 客户端主机名识别
    - 通过 ident 确定客户端用户
2. 接受请求报文
    连接上有数据到达时，Web 服务器会从网络连接中读取数据，并将请求报文中的内容解析出来。
    有些 Web 服务器还会用便于进行报文操作的内部数据结构来存储请求报文。
    因为请求可能会在任意时刻到达，所以 Web 服务器会不停地观察有无新的 Web 请求。不同的 Web 服务器结构会以不同的方式为请求服务。
    - 单线程 Web 服务器
    - 多进程及多线程 Web 服务器
    - 复用 I/O 的服务器
    - 复用的多线程 Web 服务器
3. 处理请求
    根据方法、资源、首部和可选的主体部分来对请求进行处理了。
4. 对资源的映射及访问
    在 Web 服务器将内容传送给客户端之前，要将请求报文中的 URI 映射为 Web 服务 器上适当的内容或内容生成器，以识别出内容的源头。
    - docroot：Web 服务器的文件系统中会有一个特殊的文件夹专门用于存放 Web 内容。这个文件夹被称为文档的根目录（document root，或 docroot）。Web 服务器从请求报文中获取 URI，并将其附加在文档根目录的后面。
    - 目录列表：Web 服务器可以接收对目录 URL 的请求，其路径可以解析为一个目录，而不是文件。我们可以对大多数 Web 服务器进行配置，使其在客户端请求目录 URL 时采取不同的动作。
    - 动态内容资源的映射：映射到按需动态生成内容的程序上去
    - 服务器端包含项（SSI）：如果某个资源被标识为存在服务器端包含项，服务器就会在将其发送给客户端之前对资源内容进行处理。
    - 访问控制：Web 服务器还可以为特定资源进行访问控制。
5. 构建响应
    一旦 Web 服务器识别出了资源，就执行请求方法中描述的动作，并返回响应报文。响应报文中包含有响应状态码、响应首部，如果生成了响应主体的话，还包括响应主体。
    - 响应实体：如果事务处理产生了响应主体，就将内容放在响应报文中回送过去。
      通常包括：
        描述了响应主体 MIME 类型的 Content-Type 首部；
        描述了响应主体长度的 Content-Length 首部；
        实际报文的主体内容。
    - MIME类型：Web 服务器要负责确定响应主体的 MIME 类型。
    - 重定向：Web 服务器有时会返回重定向响应而不是成功的报文。 Web 服务器可以将浏览器重定向到其他地方来执行请求。重定向响应由返回码 3XX 说明。Location 响应首部包含了内容的新地址或优选地址的 URI。
        - 永久搬离的资源
        - 临时搬离的资源
        - URL 增强
        - 负载均衡
        - 服务器关联
        - 规范目录名称
6. 发送响应
    服务器要记录连接的状态，还要特别注意对持久连接的处理。对非持久连接而言，服务器应该在发送了整条报文之后，关闭自己这一端的连接。
    对持久连接来说，连接可能仍保持打开状态，在这种情况下，服务器要特别小心，要正确地计算 Content-Length 首部，不然客户端就无法知道响应什么时候结束了
7. 记录日志
    最后，当事务结束时，Web 服务器会在日志文件中添加一个条目，来描述已执行的事务。大多数 Web 服务器都提供了几种日志配置格式
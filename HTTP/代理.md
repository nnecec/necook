# 代理

> 《HTTP 权威指南》第六章 代理

Web 代理（proxy）服务器是网络的中间实体。代理位于客户端和服务器之间，扮演“中间人”的角色，在各端点之间来回传送 HTTP 报文。

## Web 的中间实体

Web 上的代理服务器是代表客户端完成事务处理的中间人。代理服务器既是 Web 服务器又是 Web 客户端。HTTP 客户端会向代理发送请求报文，代理服务器必须像 Web 服务器一样，正确地处理请求和连接，然后返回响应。

### 私有和共享代理

单个客户端专用的代理被称为私有代理。众多客户端共享的代理被称为公共代理。

### 代理与网关的对比

严格来说，代理连接的是两个或多个使用相同协议的应用程序，而网关连接的则是两个或多个使用不同协议的端点。网关扮演的是“协议转换器”的角色，即使客户端和服务器使用的是不同的协议，客户端也可以通过它完成与服务器之间的事务处理。

## 为什么使用代理

它们可以改善安全性，提高性能，节省费用。代理服务器可以看到并接触到所有流过的 HTTP 流量，所以代理可以监视流量并对其进行修改，以实现很多有用的增值 Web 服务。

- 儿童过滤器
- 文档访问控制
- 安全防火墙
- Web 缓存
- 反向代理
- 内容路由器
- 转码器
- 匿名者

## 代理会去往何处

### 代理服务器的部署

- 出口代理：可以将代理固定在本地网络的出口点，以便控制本地网络与大型因特网之间的流量。
- 访问（入口）代理：代理常被放在 ISP 访问点上，用以处理来自客户的聚合请求。
- 反向代理：代理通常会被部署在网络边缘，在 Web 服务器之前，作为替代物（也常被称为反向代理使用，在那里它们可以处理所有传送给 Web 服务器的请求，并只在必要时向 Web 服务器请求资源。
- 网络交换代理：可以将具有足够处理能力的代理放在网络之间的因特网对等交换点上

### 代理的层次结构

可以通过代理层次结构（proxy hierarchy）将代理级联起来。在代理的层次结构中，会将报文从一个代理传给另一个代理，直到最终抵达原始服务器为止（然后通过代理传回给客户端）。

### 代理是如何获取流量的

客户端通常会直接与 Web 服务器进行通信，所以我们要解释清楚 HTTP 流量怎样才能首先流向代理。有四种常见方式可以使客户端流量流向代理。

- 修改客户端
- 修改网络
- 修改 DNS 的命名空间
- 修改 Web 服务器

## 客户端的代理设置

所有现代的 Web 浏览器都允许用户对代理的使用进行配置。实际上，很多浏览器都提供了多种配置代理的方式，其中包括以下几种。

- 手工配置
- 预先配置浏览器
- 代理的自动配置（Proxy Auto-Configuration，PAC）
- WPAD 的代理发现

## 与代理请求有关的一些棘手问题

### 代理 URI 与服务器 URI 的不同

除了一点之外，Web 服务器报文和 Web 代理报文的语法是一样的。客户端向服务器而不是代理发送请求时，HTTP 请求报文中的 URI 会有所不同。

客户端向 Web 服务器发送请求时，请求行中只包含部分 URI（没有方案、主机或端口），但当客户端向代理发送请求时，请求行中则包含完整的 URI。

### 与虚拟主机一样的问题

代理“缺少方案 / 主机 / 端口”的问题与虚拟主机 Web 服务器面临的问题相同。

尽管它们出现的问题相似，但解决方法却有所不同：

- 显式的代理要求在请求报文中使用完整 URI 来解决这个问题；
- 虚拟主机 Web 服务器要求使用 Host 首部来承载主机和端口信息。

### 拦截代理会收到部分 URI

客户端并不总是知道它是在和代理进行对话，因为有些代理对客户端可能是不可见的。即使没有将客户端配置为使用代理，客户端的流量也可能会经过替代物或拦截代理。在这两种情况下，客户端都会认为它在与 Web 服务器进行对话，不会发送完整的 URI。

### 代理既可以处理代理请求，也可以处理服务器请求

### 转发过程中对 URI 的修改

### URI 的客户端自动扩展和主机名解析

### 没有代理时对 URI 的解析

### 有显式代理时 URI 的解析

### 有拦截代理时 URI 的解析

## 追踪报文


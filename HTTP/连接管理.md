# 连接管理

> 《HTTP 权威指南》第四章 连接管理

- HTTP 是如何使用 TCP 连接的；
- TCP 连接的时延、瓶颈以及存在的障碍；
- HTTP 的优化，包括并行连接、keep-alive（持久连接）和管道化连接；
- 管理连接时应该以及不应该做的事情。

## TCP 连接

TCP/IP 是全球计算机及网络设备都在使用的一种常用的分组交换网络分层协议集。客户端应用程序可以打开一条 TCP/IP 连接，连接服务器。一旦连接建立，在客户端和服务器的计算机之间交换的报文就永远不会丢失、受损或失序。

1. TCP 的可靠数据管道
  HTTP 实际上就是 TCP 连接及其使用规则。TCP 连接是因特网上的可靠连接。TCP 为 HTTP 提供了一条可靠的比特传输管道。
2. TCP流是分段的、由IP分组传送
  TCP 的数据是通过名为 IP 分组（或 IP 数据报）的小数据块来发送的。HTTP 就是“HTTP over TCP over IP”这个“协议栈”中的最顶层了。其安全版本 HTTPS 就是在 HTTP 和 TCP 之间插入了一个（称为 TLS 或 SSL 的）密码加密层。每个 TCP 段都是由 IP 分组承载，从一个 IP 地址发送到另一个 IP 地址的。
3. 保持TCP连接的持续不间断地运行
  在任意时刻计算机都可以有几条 TCP 连接处于打开状态。TCP 是通过*端口号*来保持所有这些连接的正确运行的。
4. 用 TCP 套接字编程

## 对 TCP 性能的考虑

HTTP 紧挨着 TCP，位于其上层，所以 HTTP 事务的性能在很大程度上取决于底层 TCP 通道的性能。

### HTTP 事务的时延

HTTP 事务的时延有以下几种主要原因:

1. 客户端首先需要根据 URI 确定 Web 服务器的 IP 地址和端口号。如果最近没有对 URI 中的主机名进行访问，通过 DNS 解析系统将 URI 中的主机名转换成一个 IP 地址可能要花费数十秒的时间。如果已经在本地“缓存”（记录）了 IP 地址，查询就可以立即完成。
2. 接下来，客户端会向服务器发送一条 TCP 连接请求，并等待服务器回送一个请求接受应答。每条新的 TCP 连接都会有连接建立时延。这个值通常最多只有一两秒钟，但如果有数百个 HTTP 事务的话，这个值会快速地叠加上去。
3. 一旦连接建立起来了，客户端就会通过新建立的 TCP 管道来发送 HTTP 请求。数据到达时，Web 服务器会从 TCP 连接中读取请求报文，并对请求进行处理。因特网传输请求报文，以及服务器处理请求报文都需要时间。
4. 然后，Web 服务器会回送 HTTP 响应，这也需要花费时间。

TCP 网络时延的大小取决于硬件速度、网络和服务器的负载，请求和响应报文的尺寸，以及客户端和服务器之间的距离。TCP 协议的技术复杂性也会对时延产生巨大的影响。

### 性能聚焦区域

本节其余部分列出了一些会对 HTTP 程序员产生影响的、最常见的 TCP 相关时延，其中包括：

- TCP 连接建立握手；
- TCP 慢启动拥塞控制；
- 数据聚集的 Nagle 算法；
- 用于捎带确认的 TCP 延迟确认算法；
- TIME_WAIT 时延和端口耗尽。

## HTTP 连接的处理

### 常被误解的 Connection 首部

### 串行事务处理时延

如果只对连接进行简单的管理，TCP 的性能时延可能会叠加起来。

## 并行连接

HTTP 允许客户端打开多条连接，并行地执行多个 HTTP 事务。

1. 并行连接可能会提高页面的加载速度
2. 并行连接不一定更快
  如果并行加载多个对象，每个对象都会去竞争这有限的带宽，每个对象都会以较慢的速度按比例加载，这样带来的性能提升就很小，甚至没什么提升。
3. 并行连接可能让人“感觉”更快一些

## 持久连接

Web 客户端经常会打开到同一个站点的连接。因此，初始化了对某服务器 HTTP 请求的应用程序很可能会在不久的将来对那台服务器发起更多的请求。这种性质被称为站点局部性（site locality）。

因此，HTTP/1.1（以及 HTTP/1.0 的各种增强版本）允许 HTTP 设备在事务处理结束之后将 TCP 连接保持在打开状态，以便为未来的 HTTP 请求重用现存的连接。在事务处理结束之后仍然保持在打开状态的 TCP 连接被称为持久连接。

重用已对目标服务器打开的空闲持久连接，就可以避开缓慢的连接建立阶段。而且，已经打开的连接还可以避免慢启动的拥塞适应阶段，以便更快速地进行数据的传输。

1. 持久以及并行连接

持久连接与并行连接配合使用可能是最高效的方式。现在，很多 Web 应用程序都会打开少量的并行连接，其中的每一个都是持久连接。持久连接有两种类型：比较老的 HTTP/1.0+“keep-alive”连接，以及现代的 HTTP/1.1“persistent”连接。
# 7.网络编程

Node是一个面向网络而生的平台，它具有事件驱动、无阻塞、单线程等特性。

1. 构建TCP服务

   1. TCP

      TCP全名为传输控制协议，在OSI模型（由七层组成，分别为物理层、数据链结层、网络层、传输层、会话层、表示层、应用层）中属于传输层协议。许多应用层协议基于TCP构建，典型的是HTTP、SMTP、IMAP等协议。

      TCP是面向连接的协议，其显著的特征是在传输之前需要3次握手形成会话。客户端请求连接，服务器端响应，客户端开始传输。

   2. 创建TCP服务器端

      net.createServer(listener)

   3. TCP服务的事件

      代码分为服务器事件和连接事件

      1. 服务器事件

         通过`net.createServer()`创建的服务器而言，它是一个EventEmitter实例，它的自定义事件有如下几种：

         - listening：在调用`server.listen()`绑定端口或者Domain Socket后触发
         - connection：每个客户端套接字连接到服务器端时触发，简洁写法为通过`net.createServer()`，最后一个参数传递。
         - close：当服务器关闭时触发，在调用`server.close()`后，服务器将停止接受新的套接字连接，但保持当前存在的连接，等待所有链接都断开后，会触发该事件。
         - error：当服务器发生异常时，将会触发该事件。

      2. 连接事件

         服务器可以同时与多个客户端保持连接，对于每个连接而言是典型的可写可读Stream对象。Stream对象可以用于服务器端和客户端之间的通信。它具有如下自定义事件：

         - data：当一端调用`write()`发送数据时，另一端会触发data事件，事件传递的数据即是`write()`发送的数据。

         - end：当连接中的任意一端发送了FIN数据时，将会触发该事件。

         - connect：该事件用于客户端，当套接字与服务器端连接成功时会被触发。

         - drain：当任意一端调用`write()`发送数据时，当前这端会触发该事件。

         - error：当异常发生时，触发该事件。

         - close：当套接字完全关闭时，触发该事件。

         - timeout：当一定时间后连接不在活跃时，该事件将会被触发，通知用户当前该连接已经被闲置了。

           由于TCP套接字是可写可读的Stream对象，可以利用`pipe()`方法巧妙地实现管道操作。

           TCP针对网络中的小数据包有一定的优化策略：Nagle算法。要求缓冲区的数据达到一定数量或者一定时间后才将其发出，所以小数据包将会被Nagle算法合并。

2. 构建UDP服务

   UDP又称用户数据包协议，与TCP一样同属于网络传输层。TCP中连接一旦建立，所有的会话都基于连接完成，客户端如果要与另一个TCP服务通信，需要另创建一个套接字来完成连接。但在UDP中，一个套接字可以与多个UDP服务通信，它虽然提供面向事务的简单不可靠信息传输服务，在网络差的情况下存在丢包严重的问题，但由于它无需连接，资源消耗低，处理快速且灵活，所以常常应用在偶尔丢一两个数据包也不会产生重大影响的场景。

   1. 创建UDP套接字

      UDP套接字一旦创建，既可以作为客户端发送数据，也可以作为服务器端接收数据。

   2. 创建UDP服务器端

      若想让UDP套接字接收网络消息，只要调用`dgram.bind(port, [address])`方法对网卡和端口进行绑定即可。

   3. 创建UDP客户端

   4. UDP套接字事件

      UDP套接字是EventEmitter的实例

      - message：当UDP套接字侦听网卡端口后，接收到消息时触发该事件，触发携带的数据为消息Buffer对象和一个远程地址信息。
      - listening：当UDP套接字开始侦听时触发该事件。
      - close：调用`close()`方法时触发该事件，并不再触发`message`事件。如需再次触发`message`事件，重新绑定即可。
      - error：当异常发生时触发该事件，如果不侦听，异常将直接抛出，使进程推出。

3. 构建HTTP服务

   1. HTTP

      1. 初识HTTP

         HTTP全称是超文本传输协议，HTTP构建在TCP之上，属于应用层协议。在HTTP的两端是服务器和浏览器，即著名的B/S模式。

      2. HTTP报文

         在启动上述服务器端代码后，我们对经典示例代码进行一次报文的获取。

         网络通信的报文信息分为几个部分：第一部分内容为经典的TCP的3次握手过程；第二部分是在完成握手之后，客户端向服务器端发送请求报文；第三部分是服务器端完成处理后，向客户端发送响应内容，包括响应头和响应体；最后部分是结束会话的信息。

         从上述的报文信息中可以看出HTTP的特点，它是基于请求响应式的。报文内容都包括两个部分：报文头和报文体。

   2. http模块

      在Node中，HTTP服务继承自TCP服务器（net模块），它能够与多个客户端保持连接，由于其采用事件驱动的形式，并不为每一个连接创建额外的线程或进程，保持很低的内存占用，所以能实现高并发。HTTP服务与TCP服务模型的区别是，在开启keepalive后，一个TCP会话可以用于多次请求和响应。TCP服务以connection为单位进行服务，HTTP服务以request为单位进行服务。http模块即是将connection到request的过程进行了封装。

      1. HTTP请求

         对于TCP连接的读操作，http模块将其封装为ServerRequest对象。

      2. HTTP响应

         `res.setHeader()`和`res.writeHead()`，报头在报文体发送前发送的。无论服务器端在处理业务逻辑时是否发生异常，务必在结束时调用`res.end()`结束请求。

      3. HTTP服务的事件

         服务器也是一个EventEmitter实例

         - connection事件：在开始HTTP请求和响应前，客户端与服务端需要建立底层的TCP连接，这个链接可能因为开启了keep-alive，可以在多次请求响应之间使用；当这个连接建立时，服务器触发一次connection事件。
         - request事件：建立TCP连接后，当请求数据发送到服务器端，在解析出HTTP请求头后，将会触发该事件；在`res.end()`后，TCP连接可能将用于下一次请求响应。
         - close事件：与TCP服务器的行为一致，调用`server.close()`方法停止接受新的连接，当已有的连接都断开时，触发该事件；可以给`server.close()`传递一个回调函数来快速注册该事件。
         - checkContinue事件：某些客户端在发送较大的数据时，并不会将数据直接发送，而是先发送一个头部带`Expect: 100-continue`的请求到服务器，服务器将会触发checkContinue事件。
         - connect事件：当客户端发起CONNECT请求时触发，而发起CONNECT请求通常在HTTP代理时出现；如果不监听该事件，发起该请求的连接将会关闭。
         - dpgrade事件：当客户端要求升级连接的协议时，需要和服务器端协商，客户端会在请求头中带上Upgrade字段，服务器端会在接收到这样的请求时触发该事件。如果不监听该事件，发起该请求的连接将会关闭。
         - clientError事件：连接的客户端触发error事件时，这个错误会传递到服务器端，此时触发该事件。

   3. HTTP客户端

      1. HTTP响应

         ClientRequest在解析响应报文时，一解析完响应头就出发response事件，同时传递一个响应对象以供操作ClientResponse，后续响应报文体以只读流的方式提供

      2. HTTP代理

         http提供的ClientRequest对象也是基于TCP层实现的，在keepalive的情况下，一个底层会话连接可以多次用于请求。默认情况下，通过ClientRequest对象对同一个服务器端发起的HTTP请求最多可以创建5个连接。实质是一个连接池。

         可以设置agent选项为false值，以脱离连接池的管理，使得请求不受并发的限制。

         Agent对象的sockets和requests的属性分别表示当前连接池中使用中的连接数和处于等待状态的请求数。

      3. HTTP客户端事件

         - response：与服务器端的request事件对应的客户端在请求发出后得到服务器端响应时，会触发该事件。
         - socket：当底层连接池中建立的连接分配给当前请求对象时，触发该事件。
         - connect：当客户端向服务器端发起CONNECT请求时，如果服务器端响应了200状态码，客户端将会触发该事件。
         - upgrade：客户端向服务器端发起Upgrade请求时，如果服务器端响应了`101 Switching Protocols`状态，客户端将会触发该事件。
         - continue：客户端向服务器端发起`Expect: 100-continue`头信息，以试图发送较大数据量，如果服务器端响应`100 Continue`状态，客户端将触发该事件。

      4. 构建WebSocket服务

         WebSocket客户端基于事件的编程模型与Node中自定义事件相差无几。WebSocket实现了客户端与服务器端之间的长连接，而Node事件驱动的方式十分擅长与大量的客户端保持高并发连接。

         好处：

         - 客户端与服务器端只建立一个TCP连接，可以使用更少的连接。
         - WebSocket服务器端可以推送数据到客户端，这远比HTTP请求响应模式更灵活、更高效。
         - 有更轻量级的协议头，减少数据传送量。

         WebSocket网页客户端只需一个TCP连接即可完成双向通信，协议主要分为两个部分：握手和数据传输。

         1. WebSocket握手

            通过HTTP发起请求报文，与普通的HTTP请求协议的区别在于这些协议头：

            ```
            Upgrade: websocket
            Connection: Upgrade
            ```

            `Sec-WebSocket-Key`用于安全校验，`Sec-WebSocket-Protocol`指定子协议，`Sec-WebSocket-Version`制定版本号。

            一旦WebSocket握手成功，服务器端与客户端将会呈现对等的效果，都能接收和发送消息。

         2. WebSocket数据传输

            在握手顺利完成后，当前连接将不再进行HTTP的交互，而是开始WebSocket的数据帧协议，实现客户端与服务器端的数据交换。

            握手完成时，客户端的`onopen()`将会被触发执行。当客户端调用`send()`发送数据时，服务器端触发`onmessage()`；当服务器端调用`send()`发送数据时，客户端的`onmessage()`触发。

            为了安全考虑，客户端需要对发送的数据帧进行掩码处理，服务器一旦受到无掩码帧，连接将关闭。而服务器发送到客户端的数据帧则无须做掩码处理，如果客户端收到带掩码的数据帧，连接将关闭。

      5. 网络服务与安全

         SSL（安全套接层），TLS（安全传输层协议）

         1. TLS/SSL

            1. 密钥

               TLS/SSL是一个公钥/私钥的结构，它是一个非对称的结构，每个服务器端和客户端都有自己的公私钥。公钥用来加密要传输的数据，私钥用来解密接收到的数据。公钥和私钥是配对的，通过公钥加密的数据，只有通过私钥才能揭秘，所以在建立安全传输之前，客户端和服务器端之间需要互换公钥。

               Node在底层采用的是openssl实现TLS/SSL。

               数据传输的过程中还需要对得到的公钥进行认证，以确认得到的公钥是出自目标服务器。

            2. 数字证书

               CA的作用是为站点颁发证书，且这个证书中具有CA通过自己的公钥和私钥实现的签名。为了得到签名证书，服务器端需要通过自己的私钥生成CSR（证书签名请求）文件。CA机构将通过这个文件颁发属于该服务端的签名证书，只要通过CA机构就能验证证书是否合法。

               服务端需要向CA机构申请签名证书。在申请签名证书之前依然要创建自己的CSR文件。

         2. TLS服务

            1. 创建服务器端

            2. TLS客户端

               启动客户端的过程中，用到了为客户端生成的私钥、证书、CA证书。

         3. HTTPS服务

            HTTPS服务就是工作在TLS/SSL上的HTTP。

            1. 准备证书

               HTTPS服务需要用到私钥和签名证书

            2. 创建HTTPS服务

               创建HTTPS服务只比HTTP服务多一个选项配置。

            3. HTTPS客户端

      6. 总结

         Node基于事件驱动和非阻塞设计，在分布式环境中尤其能发挥出它的特长，基于事件驱动可以实现与大量的客户端进行连接，非阻塞设计则让它可以更好地提升网络的响应吞吐。Node提供了相对底层的网络调用，以及基于事件的编程接口。